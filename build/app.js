// Generated by CoffeeScript 1.7.1
(function() {
  var app, bodyParser, express, fs, http, logfile, path;

  http = require("http");

  fs = require("fs");

  path = require("path");

  bodyParser = require('body-parser');

  express = require('express');

  logfile = function(data) {
    console.log("LOG - " + data);
    return fs.appendFileSync("./production.log", data.toString() + "\n");
  };

  app = express();

  app.use(bodyParser());

  logfile("APP INIT");

  app.get('/', function(req, res) {
    logfile("GET index");
    return res.sendFile(path.join(__dirname, '../public', 'index.html'));
  });

  app.post('/results', function(req, res) {
    var applySpooky, resultsTest, url;
    logfile("POST results");
    url = req.body.url;
    applySpooky = require("build/spooky-parser");
    applySpooky(url, logfile);
    resultsTest = function() {
      return setTimeout(function() {
        var resultsPath;
        resultsPath = path.join(__dirname, "../tmp", "results.csv");
        if (fs.existsSync(resultsPath)) {
          return res.sendFile(resultsPath, {}, function() {
            return fs.unlink(resultsPath);
          });
        } else {
          return resultsTest();
        }
      }, 500);
    };
    return resultsTest();
  });

  app.listen(8000);

}).call(this);
