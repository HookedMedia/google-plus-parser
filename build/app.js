// Generated by CoffeeScript 1.7.1
(function() {
  var app, bodyParser, config, express, fs, http, logfmt, path, port;

  http = require("http");

  fs = require("fs");

  path = require("path");

  bodyParser = require('body-parser');

  express = require('express');

  logfmt = require("logfmt");

  config = require(path.join(__dirname, "config"));

  app = express();

  app.use(bodyParser());

  app.use(logfmt.requestLogger());

  port = Number(process.env.PORT || 5000);

  app.get('/', function(req, res) {
    console.log("GET index");
    return res.sendFile(path.join(__dirname, '../public', 'index.html'));
  });

  app.post('/results', function(req, res) {
    var applySpooky, resultsTest, url;
    console.log("POST results");
    url = req.body.url;
    applySpooky = require(path.join(__dirname, "spooky-parser"));
    applySpooky(url);
    resultsTest = function() {
      return setTimeout(function() {
        var resultsPath;
        resultsPath = path.join(__dirname, "../tmp", config.filename);
        if (fs.existsSync(resultsPath)) {
          if (config.json) {
            res.header("Content-Type", "application/json");
          }
          return res.sendFile(resultsPath, {}, function() {
            return fs.unlink(resultsPath);
          });
        } else {
          return resultsTest();
        }
      }, 500);
    };
    return resultsTest();
  });

  app.listen(port);

  console.log("started on port: " + port);

}).call(this);
